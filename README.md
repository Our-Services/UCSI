# بوت إدخال بيانات باستخدام Playwright (Python)

مشروع صغير لأتمتة تعبئة نموذج في موقع ثابت البنية، يتغير رابط الصفحة في كل مرة.

## المتطلبات
- Python 3.10+
- تثبيت الاعتماديات:
  - `pip install -r requirements.txt`
  - ثم مرة واحدة لتنزيل المتصفحات: `python -m playwright install`

## الإعداد
- عدّل ملف `config/config.json`:
  - `url`: ضع رابط الصفحة المطلوب كل مرة.
  - `fields`: قائمة حقول الإدخال مع محددات CSS وقيمها.
  - `submit.selector`: محدد زر الإرسال (إن وجد).
  - `wait_for.selector`: عنصر يظهر بعد النجاح (اختياري).
  - `screenshot_path`: مسار لقطة الشاشة الناتجة.

مثال:
```json
{
  "url": "https://example.com/form",
  "fields": [
    { "selector": "#name", "value": "أحمد" },
    { "selector": "#email", "value": "ahmed@example.com" }
  ],
  "submit": { "selector": "button[type='submit']" },
  "wait_for": { "selector": ".success, .alert-success", "timeout_ms": 12000 },
  "screenshot_path": "output/last.png"
}
```

## التشغيل (مستخدمون متعددون)
- عدّل `config/config.json`:
  - `url`: ضع رابط صفحة الحضور الحالي (يتغير كل مرة).
  - `users`: قائمة من `{ studentId, password }` لجميع من تريد تسجيل حضورهم.
  - `geolocation`: مصدر الموقع. إذا أردته تلقائيًا من موقع تشغيل السكربت:
    - `{ "source": "ip", "accuracy": 50 }`
    - يعتمد على عنوان IP العام لتحديد الإحداثيات تلقائيًا.
    - إن رغبت بإحداثيات ثابتة، استخدم `{ "source": "fixed", "latitude": <lat>, "longitude": <lon>, "accuracy": 50 }`.
  - `login`: تخصيص أسماء الحقول/الأزرار، أو محددات CSS إن لزم.
  - `checkin`: أسماء زر الحضور ومحدد نجاح (اختياري).

- شغّل:
  - `python src/bot.py --config config/config.json --url https://iisv2.ucsiuniversity.edu.my/apex/iisv2/r/attendance/attendance-sign-in?p...`
  - إذا أردت التشغيل خفيًا: أنشئ `.env` وضع `HEADLESS=1`.

- ينتج صورًا لكل مستخدم في `output/{studentId}.png`.

## ملاحظات
- إن اختلفت أسماء الأزرار (مثل "Sign In"/"Login"/"Check-In")، السكربت يجرب تلقائيًا وفقًا للقائمة في `config.json`.
- إن تطلب الموقع إذن الموقع، يتم منحه تلقائيًا وتحديد الإحداثيات من `geolocation`.
- إن تغيّرت محددات الحقول، استخدم `login.overrides` لتعريف محددات CSS مباشرة.

## التحكم عبر تيليجرام (اختياري)
- يمكنك تشغيل البوت عبر تيليجرام بدل فتح الواجهة:
  1. أنشئ بوت عبر BotFather واحصل على `TELEGRAM_TOKEN`.
  2. ضع المتغيرات في `.env`:
     - `TELEGRAM_TOKEN=<توكن البوت>`
     - `TELEGRAM_ALLOWED_IDS=<معرفات المستخدم المسموح لهم، مفصولة بفواصل>` مثل `123456789,987654321`.
  3. ثبّت الاعتماديات (إن لم تكن مثبتة): `pip install python-telegram-bot==21.6`.
  4. شغّل: `python src/telegram_bot.py`.
  5. الأوامر المتاحة داخل تيليجرام:
     - `/start` لعرض المساعدة.
     - `/run` لتشغيل الأتمتة باستخدام إعدادات `config/config.json` الحالية.
     - `/status` لعرض حالة التشغيل الحالية.
     - `/seturl <url>` لتحديث رابط الحضور.
     - `/setheadless <0|1>` لتبديل وضع التشغيل الخفي.

 6. قائمة أزرار داخل `/start`:
    - يظهر زر "تشغيل" و"الحالة" للتنفيذ السريع.
    - يظهر زر "إنشاء تحضير جديد" لفتح معالج التحضير (رابط + مادة + الموقع).
    - يظهر زر "إضافة مستخدم جديد" و"إدارة المستخدمين".
    - يظهر زر "عرض آخر 10 تحضيرات".

### الاستضافة 24/7 (دائمًا شغال)
لجعل بوت تيليجرام يعمل 24/7 حتى لو أغلقت جهازك المحلي، شغّله على خادم دائم التشغيل أو منصة حاويات:
- خيار A — Docker على خادم (موصى به):
  1. انسخ المشروع إلى الخادم.
  2. عرّف متغير البيئة `TELEGRAM_TOKEN` هناك (لا تحفظه داخل المستودع).
  3. شغّل عبر Docker Compose:
     - `docker compose up -d`
     - يستخدم `restart: always` ويثبت مجلدَي `config/` و `output/` للحفظ.
  4. تأكد من تشغيل نسخة واحدة فقط حتى لا يظهر خطأ "terminated by other getUpdates request" من تيليجرام.
- خيار B — منصات حاويات مُدارة (Render, Railway, Fly.io):
  - استخدم `Dockerfile` المرفق.
  - اضبط `TELEGRAM_TOKEN` كمتغير سري في المنصة.
  - انشر الخدمة؛ وضع polling يعمل دون الحاجة لمنفذ عام.
- خيار C — عملية طويلة على خادم Linux:
  - ثبّت بايثون والاعتماديات.
  - استخدم مدير عمليات (`systemd` أو `pm2`) مع إعادة تشغيل تلقائي.

ملاحظات:
- وضع polling يحتاج إنترنت خارجي فقط، لا يتطلب HTTPS داخِل.
- لا تشغّل أكثر من نسخة للبوت في نفس الوقت.
- احفظ `config/config.json` و`output/` للاستفادة من السجل واللقطات.

- ملاحظة: التنفيذ الفعلي يتم على الجهاز/الخادم الذي يشغّل سكربت تيليجرام، وليس على هاتفك.
 - لتشغيل واجهة الويب:
   - شغّل الخدمة: `HOST=0.0.0.0 PORT=5000 python src/web_app.py`.
   - افتح من الهاتف على نفس الشبكة: `http://<IP-الكمبيوتر>:5000/auto`.