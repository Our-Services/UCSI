<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Manage Accounts</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  </head>
  <body>
    <div class="nav">
      <div class="container">
        <a href="{{ url_for('manage') }}">Manage Accounts</a>
      </div>
    </div>
    <div class="container">
      <h2>Manage Accounts</h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="flash {{ category }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    {% if not authed %}
      <div class="card">
        <div class="card-header">Admin Login</div>
        <form method="post" action="{{ url_for('manage_login') }}">
          <div class="row grid cols-2">
            <div>
              <label>Username</label>
              <input type="text" name="admin_user" />
            </div>
            <div>
              <label>Password</label>
              <input type="password" name="admin_pwd" />
            </div>
          </div>
          <div class="actions">
            <button type="submit" class="btn btn-primary">Login</button>
          </div>
        </form>
      </div>
      <p class="flash info">Manage student data (locked)</p>
    {% else %}
      <div class="actions">
        <a href="{{ url_for('manage', view='req') }}" class="btn {{ 'btn-primary' if view == 'req' else 'btn-secondary' }}">Account Requests</a>
        <a href="{{ url_for('manage', view='users') }}" class="btn {{ 'btn-primary' if view == 'users' else 'btn-secondary' }}">Manage Registered Users</a>
        <a href="{{ url_for('auto') }}" class="btn btn-secondary">Back</a>
      </div>

      {% if view == 'req' %}
        <div class="card">
          <div class="card-header">Account Requests (Pending)</div>
          {% if not pendings %}
            <p class="flash info">No pending requests.</p>
          {% else %}
          <table>
            <thead>
              <tr><th>Student ID</th><th>Password</th><th>Name</th><th>Phone</th><th>Actions</th></tr>
            </thead>
            <tbody>
              {% for p in pendings %}
                <tr>
                  <td>{{ p.get('studentId','') }}</td>
                  <td>{{ p.get('password','') }}</td>
                  <td>{{ p.get('username','') }}</td>
                  <td>{{ p.get('phone','') }}</td>
                  <td>
                    <form method="post" action="{{ url_for('manage_approve') }}" style="display:inline-flex; gap:6px;">
                      <input type="hidden" name="studentId" value="{{ p.get('studentId','') }}" />
                      <button type="submit" class="btn btn-primary">Approve</button>
                    </form>
                    <form method="post" action="{{ url_for('manage_reject') }}" style="display:inline-flex; gap:6px;">
                      <input type="hidden" name="studentId" value="{{ p.get('studentId','') }}" />
                      <button type="submit" class="btn btn-secondary">Reject</button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
          {% endif %}
        </div>
      {% else %}
        <div class="card">
          <div class="card-header">Registered Users</div>
          <table>
            <thead>
              <tr><th>Student ID</th><th>Password</th><th>Name</th><th>Phone</th><th>Subjects</th><th>Actions</th></tr>
            </thead>
            <tbody>
              {% for u in users %}
                {% set subs = u.get('subjects', []) or [] %}
                <tr>
                  <td>{{ u.get('studentId','') }}</td>
                  <td>{{ u.get('password','') }}</td>
                  <td>{{ u.get('username','') }}</td>
                  <td>{{ u.get('phone','') }}</td>
                  <td>{{ subs | join(', ') if subs else 'â€”' }}</td>
                  <td style="min-width:280px;">
                    <!-- Edit basic info -->
                    <form method="post" action="{{ url_for('manage_update') }}" style="display:grid; grid-template-columns:1fr 1fr 1fr auto; gap:6px; align-items:center;">
                      <input type="hidden" name="studentId" value="{{ u.get('studentId','') }}" />
                      <input type="text" name="username" placeholder="Name" value="{{ u.get('username','') }}" />
                      <input type="text" name="phone" placeholder="Phone" value="{{ u.get('phone','') }}" />
                      <input type="text" name="password" placeholder="Password" />
                      <button type="submit" class="btn btn-primary">Save</button>
                    </form>
                    <!-- Delete user -->
                    <form method="post" action="{{ url_for('manage_delete') }}" style="margin-top:6px; display:inline-flex; gap:6px;">
                      <input type="hidden" name="studentId" value="{{ u.get('studentId','') }}" />
                      <button type="submit" class="btn btn-secondary">Delete</button>
                    </form>
                    <!-- Manage subjects: add from global library -->
                    <form method="post" action="{{ url_for('manage_subject_add') }}" style="margin-top:6px; display:grid; grid-template-columns:1fr auto; gap:6px;">
                      <input type="hidden" name="studentId" value="{{ u.get('studentId','') }}" />
                      <select name="subject">
                        {% if not subjects_library %}
                          <option value="" disabled selected>No subjects in library</option>
                        {% else %}
                          {% for sopt in subjects_library %}
                            <option value="{{ sopt }}">{{ sopt }}</option>
                          {% endfor %}
                        {% endif %}
                      </select>
                      <button type="submit" class="btn btn-primary">Add Subject</button>
                    </form>
                    {% for s in subs %}
                      <form method="post" action="{{ url_for('manage_subject_remove') }}" style="margin-top:6px; display:inline-flex; gap:6px;">
                        <input type="hidden" name="studentId" value="{{ u.get('studentId','') }}" />
                        <input type="hidden" name="subject" value="{{ s }}" />
                        <button type="submit" class="btn btn-secondary">Remove {{ s }}</button>
                      </form>
                    {% endfor %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
    {% endif %}
    </div>

    {% if authed and view == 'users' %}
    <div class="container" style="margin-top:16px;">
      <div class="card">
        <div class="card-header">Subjects Library</div>
        <form method="post" action="{{ url_for('manage_subjects_add_global') }}" style="display:grid; grid-template-columns:1fr auto; gap:6px;">
          <input type="text" name="subject" placeholder="New subject name" />
          <button type="submit" class="btn btn-primary">Add to Library</button>
        </form>
        {% if subjects_library %}
          <p style="margin-top:8px;">Available: {{ subjects_library | join(', ') }}</p>
        {% else %}
          <p class="flash info" style="margin-top:8px;">No subjects defined yet.</p>
        {% endif %}
      </div>
    </div>
    {% endif %}

  </body>
  </html>